// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User model
model User {
  id             String    @id @default(cuid())
  name           String?
  email          String?   @unique
  emailVerified  DateTime?
  image          String?
  hashedPassword String?
  username       String?   @unique
  bio            String?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  // User profile related fields
  coverImage     String?
  location       String?
  website        String?
  occupation     String?
  phoneNumber    String?
  language       String    @default("en")
  theme          String    @default("system")

  // Authentication
  accounts       Account[]
  sessions       Session[]

  // Content
  posts          Post[]
  comments       Comment[]
  reactions      Reaction[]
  savedPosts     SavedPost[]

  // User relationships
  followers      Follow[]        @relation("FollowingUser")
  following      Follow[]        @relation("FollowerUser")
  friends        Friendship[]    @relation("UserFriends")
  friendsOf      Friendship[]    @relation("FriendsOfUser")

  // Messaging
  sentMessages   Message[]       @relation("MessageSender")
  receivedMessages Message[]     @relation("MessageReceiver")

  // Notifications
  notifications  Notification[]  @relation("NotificationRecipient")
  notificationsSent Notification[] @relation("NotificationSender")
  notificationPreferences NotificationPreference?
  notificationCategoryPreferences NotificationCategoryPreference[]
  notificationGroupPreferences NotificationGroupPreference[]
  pushDevices    PushDevice[]

  // Interests and topics
  interests      UserInterest[]

  // Health data for Better Me
  healthProfile  HealthProfile?

  // Chat related
  chatParticipations ChatParticipant[]

  // Stories
  stories        Story[]
  viewedStories  StoryView[]

  // Reels
  reels          Reel[]
  reelLikes      ReelLike[]
  reelComments   ReelComment[]

  // Pages
  ownedPages     Page[]          @relation("PageOwner")
  pageRoles      PageRole[]

  // Groups
  createdGroups          Group[]             @relation("GroupCreator")
  groupMemberships       GroupMember[]
  groupInvitations       GroupInvitation[]   @relation("InvitedUser")
  sentGroupInvitations   GroupInvitation[]   @relation("InvitingUser")
  groupJoinRequests      GroupJoinRequest[]
  groupPosts             GroupPost[]
  groupComments          GroupComment[]
  groupReactions         GroupReaction[]
  groupFileUploads       GroupFile[]         @relation("FileUploader")
  groupDiscussionTopics  GroupDiscussionTopic[] @relation("TopicCreator")
  groupDiscussionReplies GroupDiscussionReply[] @relation("ReplyCreator")
  groupEvents            GroupEvent[]        @relation("EventCreator")
  groupEventParticipations GroupEventParticipation[]
  groupPolls             GroupPoll[]         @relation("PollCreator")
  groupPollVotes         GroupPollVote[]
  groupBadges            GroupBadge[]
  groupReports           GroupReport[]       @relation("ReportCreator")
  groupReportedContent   GroupReport[]       @relation("ReportedUser")

  // Events
  createdEvents  Event[]
  eventParticipations EventParticipation[]

  // AI related
  aiTokenLimit         AITokenLimit?
  aiContentAnalyses    AIContentAnalysis[]
  aiHealthRecommendations AIHealthRecommendation[]
  aiChatInteractions   AIChatInteraction[]
}

model Account {
  id                 String  @id @default(cuid())
  userId             String
  type               String
  provider           String
  providerAccountId  String
  refresh_token      String?  @db.Text
  access_token       String?  @db.Text
  expires_at         Int?
  token_type         String?
  scope              String?
  id_token           String?  @db.Text
  session_state      String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model Post {
  id          String     @id @default(cuid())
  content     String     @db.Text
  published   Boolean    @default(true)
  visibility  Visibility @default(PUBLIC)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  
  userId      String
  user        User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  media       Media[]
  comments    Comment[]
  reactions   Reaction[]
  savedBy     SavedPost[]
  
  aiAnalysis  AIAnalysis?
  
  hashtags    PostHashtag[]

  @@index([userId])
}

model Media {
  id          String     @id @default(cuid())
  type        MediaType
  url         String
  thumbnailUrl String?
  createdAt   DateTime   @default(now())

  postId      String?
  post        Post?      @relation(fields: [postId], references: [id], onDelete: Cascade)

  commentId   String?
  comment     Comment?   @relation(fields: [commentId], references: [id], onDelete: Cascade)

  messageId   String?
  message     Message?   @relation(fields: [messageId], references: [id], onDelete: Cascade)

  storyId     String?
  story       Story?     @relation(fields: [storyId], references: [id], onDelete: Cascade)

  reelId      String?
  reel        Reel?      @relation(fields: [reelId], references: [id], onDelete: Cascade)

  groupPostId String?
  groupPost   GroupPost? @relation(fields: [groupPostId], references: [id], onDelete: Cascade)

  @@index([postId])
  @@index([commentId])
  @@index([messageId])
  @@index([storyId])
  @@index([reelId])
  @@index([groupPostId])
}

model Comment {
  id          String     @id @default(cuid())
  content     String
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  
  userId      String
  user        User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  postId      String
  post        Post       @relation(fields: [postId], references: [id], onDelete: Cascade)
  
  parentId    String?
  parent      Comment?   @relation("CommentReplies", fields: [parentId], references: [id], onDelete: SetNull)
  replies     Comment[]  @relation("CommentReplies")
  
  reactions   Reaction[]
  media       Media[]

  @@index([userId])
  @@index([postId])
  @@index([parentId])
}

model Reaction {
  id        String       @id @default(cuid())
  type      ReactionType
  createdAt DateTime     @default(now())
  
  userId    String
  user      User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  postId    String?
  post      Post?        @relation(fields: [postId], references: [id], onDelete: Cascade)
  
  commentId String?
  comment   Comment?     @relation(fields: [commentId], references: [id], onDelete: Cascade)

  @@unique([userId, postId, commentId])
  @@index([userId])
  @@index([postId])
  @@index([commentId])
}

model SavedPost {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  postId    String
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@unique([userId, postId])
  @@index([userId])
  @@index([postId])
}

model Follow {
  id           String   @id @default(cuid())
  createdAt    DateTime @default(now())
  
  followerId   String
  follower     User     @relation("FollowerUser", fields: [followerId], references: [id], onDelete: Cascade)
  
  followingId  String
  following    User     @relation("FollowingUser", fields: [followingId], references: [id], onDelete: Cascade)

  @@unique([followerId, followingId])
  @@index([followerId])
  @@index([followingId])
}

model Friendship {
  id        String           @id @default(cuid())
  status    FriendshipStatus @default(PENDING)
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt
  
  userId    String
  user      User             @relation("UserFriends", fields: [userId], references: [id], onDelete: Cascade)
  
  friendId  String
  friend    User             @relation("FriendsOfUser", fields: [friendId], references: [id], onDelete: Cascade)

  @@unique([userId, friendId])
  @@index([userId])
  @@index([friendId])
}

model Chat {
  id            String    @id @default(cuid())
  name          String?
  isGroup       Boolean   @default(false)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  participants  ChatParticipant[]
  messages      Message[]
}

model ChatParticipant {
  id        String    @id @default(cuid())
  role      ChatRole  @default(MEMBER)
  createdAt DateTime  @default(now())
  
  chatId    String
  chat      Chat      @relation(fields: [chatId], references: [id], onDelete: Cascade)
  
  userId    String
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  lastReadMessageId String?
  lastReadMessage  Message?  @relation(fields: [lastReadMessageId], references: [id])

  @@unique([chatId, userId])
  @@index([chatId])
  @@index([userId])
}

model Message {
  id               String     @id @default(cuid())
  content          String?
  createdAt        DateTime   @default(now())
  updatedAt        DateTime   @updatedAt
  isDeleted        Boolean    @default(false)
  expiresAt        DateTime?
  
  chatId           String
  chat             Chat       @relation(fields: [chatId], references: [id], onDelete: Cascade)
  
  senderId         String
  sender           User       @relation("MessageSender", fields: [senderId], references: [id], onDelete: Cascade)
  
  receiverId       String?
  receiver         User?      @relation("MessageReceiver", fields: [receiverId], references: [id])
  
  media            Media[]
  readBy           ChatParticipant[]

  @@index([chatId])
  @@index([senderId])
  @@index([receiverId])
}

model Notification {
  id            String           @id @default(cuid())
  type          NotificationType
  content       String?
  isRead        Boolean          @default(false)
  createdAt     DateTime         @default(now())
  expiresAt     DateTime?
  priority      NotificationPriority @default(NORMAL)
  isMuted       Boolean          @default(false)
  isActionable  Boolean          @default(false)
  actionLabel   String?
  actionUrl     String?
  imageUrl      String?

  // Recipient info
  recipientId   String
  recipient     User             @relation("NotificationRecipient", fields: [recipientId], references: [id], onDelete: Cascade)

  // Sender info
  senderId      String?
  sender        User?            @relation("NotificationSender", fields: [senderId], references: [id])

  // Related content references
  postId        String?
  commentId     String?
  messageId     String?

  // Group-related references
  groupId       String?
  group         Group?           @relation(fields: [groupId], references: [id])
  groupPostId   String?
  groupCommentId String?
  groupEventId  String?
  groupPollId   String?
  groupFileId   String?
  groupBadgeId  String?

  // Page-related references
  pageId        String?
  page          Page?            @relation(fields: [pageId], references: [id])

  // Health-related references
  healthProfileId String?

  // General notification URL
  url           String?

  // Delivery status for push notifications
  deliveryStatus NotificationDeliveryStatus? @default(PENDING)
  deliveredAt   DateTime?
  readAt        DateTime?

  // Metadata
  metadata      Json?

  // Preferences override for this specific notification
  overrideUserPreferences Boolean @default(false)

  @@index([recipientId])
  @@index([senderId])
  @@index([type])
  @@index([createdAt])
  @@index([isRead])
  @@index([groupId])
  @@index([pageId])
}

model Topic {
  id          String        @id @default(cuid())
  name        String        @unique
  description String?
  createdAt   DateTime      @default(now())
  
  userInterests UserInterest[]
  postHashtags  PostHashtag[]
}

model UserInterest {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  topicId   String
  topic     Topic    @relation(fields: [topicId], references: [id], onDelete: Cascade)

  @@unique([userId, topicId])
  @@index([userId])
  @@index([topicId])
}

model PostHashtag {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  
  postId    String
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  
  topicId   String
  topic     Topic    @relation(fields: [topicId], references: [id], onDelete: Cascade)

  @@unique([postId, topicId])
  @@index([postId])
  @@index([topicId])
}

model AIAnalysis {
  id               String   @id @default(cuid())
  sentiment        String?
  topics           String?  @db.Text
  suggestions      String?  @db.Text
  detectedEntities String?  @db.Text
  modelVersion     String?
  createdAt        DateTime @default(now())
  
  postId           String   @unique
  post             Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
}

model Story {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  expiresAt DateTime
  
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  media     Media[]
  views     StoryView[]

  @@index([userId])
}

model StoryView {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  
  storyId   String
  story     Story    @relation(fields: [storyId], references: [id], onDelete: Cascade)
  
  viewerId  String
  viewer    User     @relation(fields: [viewerId], references: [id], onDelete: Cascade)

  @@unique([storyId, viewerId])
  @@index([storyId])
  @@index([viewerId])
}

model Reel {
  id          String       @id @default(cuid())
  caption     String?
  createdAt   DateTime     @default(now())
  
  userId      String
  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  media       Media[]
  likes       ReelLike[]
  comments    ReelComment[]
  
  aiAnalysis  String?      @db.Text

  @@index([userId])
}

model ReelLike {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  
  reelId    String
  reel      Reel     @relation(fields: [reelId], references: [id], onDelete: Cascade)
  
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([reelId, userId])
  @@index([reelId])
  @@index([userId])
}

model ReelComment {
  id        String   @id @default(cuid())
  content   String
  createdAt DateTime @default(now())
  
  reelId    String
  reel      Reel     @relation(fields: [reelId], references: [id], onDelete: Cascade)
  
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([reelId])
  @@index([userId])
}

model Page {
  id          String    @id @default(cuid())
  name        String
  handle      String    @unique
  description String?   @db.Text
  logoImage   String?
  coverImage  String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  ownerId     String
  owner       User      @relation("PageOwner", fields: [ownerId], references: [id], onDelete: Cascade)

  roles         PageRole[]
  events        Event[]
  notifications Notification[]

  @@index([ownerId])
}

model PageRole {
  id        String    @id @default(cuid())
  role      Role      @default(MEMBER)
  createdAt DateTime  @default(now())
  
  pageId    String
  page      Page      @relation(fields: [pageId], references: [id], onDelete: Cascade)
  
  userId    String
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([pageId, userId])
  @@index([pageId])
  @@index([userId])
}

model Event {
  id          String    @id @default(cuid())
  title       String
  description String?   @db.Text
  location    String?
  startsAt    DateTime
  endsAt      DateTime?
  coverImage  String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  pageId      String?
  page        Page?     @relation(fields: [pageId], references: [id], onDelete: SetNull)
  
  creatorId   String
  creator     User      @relation(fields: [creatorId], references: [id], onDelete: Cascade)
  
  participants EventParticipation[]

  @@index([pageId])
  @@index([creatorId])
}

model EventParticipation {
  id        String           @id @default(cuid())
  status    ParticipationStatus @default(GOING)
  createdAt DateTime         @default(now())
  
  eventId   String
  event     Event            @relation(fields: [eventId], references: [id], onDelete: Cascade)
  
  userId    String
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([eventId, userId])
  @@index([eventId])
  @@index([userId])
}

// Health profile for Better Me section
model HealthProfile {
  id              String   @id @default(cuid())
  age             Int?
  weight          Float?
  height          Float?
  gender          String?
  activityLevel   String?
  goals           String?
  dietaryRestrictions String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  userId          String   @unique
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  mealPlans       MealPlan[]
  workoutPlans    WorkoutPlan[]
  progressRecords ProgressRecord[]

  // AI Recommendations
  aiRecommendations AIHealthRecommendation[]
}

model MealPlan {
  id          String   @id @default(cuid())
  name        String
  description String?
  startDate   DateTime
  endDate     DateTime?
  createdAt   DateTime @default(now())
  
  profileId   String
  profile     HealthProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)
  
  meals       Meal[]

  @@index([profileId])
}

model Meal {
  id          String   @id @default(cuid())
  name        String
  type        String   // Breakfast, Lunch, Dinner, Snack
  calories    Int?
  protein     Int?
  carbs       Int?
  fat         Int?
  recipe      String?  @db.Text
  imageUrl    String?
  
  planId      String
  plan        MealPlan @relation(fields: [planId], references: [id], onDelete: Cascade)

  @@index([planId])
}

model WorkoutPlan {
  id          String   @id @default(cuid())
  name        String
  description String?
  startDate   DateTime
  endDate     DateTime?
  createdAt   DateTime @default(now())
  
  profileId   String
  profile     HealthProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)
  
  workouts    Workout[]

  @@index([profileId])
}

model Workout {
  id          String   @id @default(cuid())
  name        String
  duration    Int?     // in minutes
  type        String   // Cardio, Strength, Flexibility, etc.
  description String?  @db.Text
  videoUrl    String?
  
  planId      String
  plan        WorkoutPlan @relation(fields: [planId], references: [id], onDelete: Cascade)
  
  exercises   WorkoutExercise[]

  @@index([planId])
}

model WorkoutExercise {
  id          String   @id @default(cuid())
  name        String
  sets        Int?
  reps        Int?
  duration    Int?     // in seconds
  restTime    Int?     // in seconds
  notes       String?
  
  workoutId   String
  workout     Workout  @relation(fields: [workoutId], references: [id], onDelete: Cascade)

  @@index([workoutId])
}

model ProgressRecord {
  id           String   @id @default(cuid())
  date         DateTime @default(now())
  weight       Float?
  energyLevel  Int?     // Scale 1-10
  sleepQuality Int?     // Scale 1-10
  notes        String?
  photoUrl     String?
  
  profileId    String
  profile      HealthProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@index([profileId])
}

// AI-related models
model AITokenLimit {
  id        String   @id @default(cuid())
  userId    String   @unique
  tier      String   @default("FREE") // FREE, BASIC, PRO, ENTERPRISE
  limit     Int      @default(150)
  usage     Int      @default(0)
  resetAt   DateTime
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model AIContentAnalysis {
  id                   String   @id @default(cuid())
  userId               String
  content              String   @db.Text
  sentiment            String
  topics               String
  engagementPrediction String
  modelUsed            String
  tokenUsage           Int
  createdAt            DateTime @default(now())

  user                 User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model AIHealthRecommendation {
  id                String   @id @default(cuid())
  userId            String
  healthProfileId   String
  goals             String
  recommendations   String   @db.Text
  modelUsed         String
  tokenUsage        Int
  createdAt         DateTime @default(now())

  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  healthProfile     HealthProfile @relation(fields: [healthProfileId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([healthProfileId])
}

// Notification preference models
model NotificationPreference {
  id                 String   @id @default(cuid())
  emailEnabled       Boolean  @default(true)
  pushEnabled        Boolean  @default(true)
  inAppEnabled       Boolean  @default(true)
  smsEnabled         Boolean  @default(false)
  quietHoursEnabled  Boolean  @default(false)
  quietHoursStart    String?  // Format: HH:MM (24h)
  quietHoursEnd      String?  // Format: HH:MM (24h)
  quietHoursDays     String?  // Comma-separated days (MON,TUE,etc)
  weekendMuteEnabled Boolean  @default(false)
  digestEnabled      Boolean  @default(false)
  digestFrequency    String?  @default("DAILY") // DAILY, WEEKLY
  digestDay          String?  // For weekly digest: MON, TUE, etc.
  digestTime         String?  // Format: HH:MM (24h)
  updatedAt          DateTime @updatedAt

  userId             String   @unique
  user               User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model NotificationCategoryPreference {
  id                 String   @id @default(cuid())
  category           String   // E.g., "SOCIAL", "GROUP", "SYSTEM", etc.
  inAppEnabled       Boolean  @default(true)
  emailEnabled       Boolean  @default(false)
  pushEnabled        Boolean  @default(true)
  smsEnabled         Boolean  @default(false)
  muteAll            Boolean  @default(false)
  muteUntil          DateTime?
  priority           NotificationPriority @default(NORMAL)
  updatedAt          DateTime @updatedAt

  userId             String
  user               User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, category])
  @@index([userId])
}

model NotificationGroupPreference {
  id                 String   @id @default(cuid())
  inAppEnabled       Boolean  @default(true)
  emailEnabled       Boolean  @default(false)
  pushEnabled        Boolean  @default(true)
  muteAll            Boolean  @default(false)
  muteUntil          DateTime?
  postsEnabled       Boolean  @default(true)
  commentsEnabled    Boolean  @default(true)
  eventsEnabled      Boolean  @default(true)
  pollsEnabled       Boolean  @default(true)
  mentionsEnabled    Boolean  @default(true)
  announcementsOnly  Boolean  @default(false)
  updatedAt          DateTime @updatedAt

  userId             String
  user               User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Which group this preference applies to
  groupId            String

  @@unique([userId, groupId])
  @@index([userId])
  @@index([groupId])
}

model PushDevice {
  id                 String   @id @default(cuid())
  deviceToken        String   @unique
  platform           String   // "ios", "android", "web"
  deviceName         String?
  deviceModel        String?
  osVersion          String?
  appVersion         String?
  isActive           Boolean  @default(true)
  lastActive         DateTime @default(now())
  createdAt          DateTime @default(now())

  userId             String
  user               User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([deviceToken])
}

model ScheduledNotification {
  id                String               @id @default(cuid())
  type              NotificationType
  content           String?
  scheduledFor      DateTime
  recurring         Boolean              @default(false)
  recurrencePattern String?              // CRON format
  recurrenceEnd     DateTime?
  channels          String?              // Comma-separated: IN_APP,EMAIL,PUSH,SMS
  priority          NotificationPriority @default(NORMAL)
  status            String               @default("PENDING") // PENDING, SENT, CANCELLED, FAILED
  createdAt         DateTime             @default(now())
  updatedAt         DateTime             @updatedAt

  // Target user(s)
  recipientId       String?              // For individual notifications
  segmentId         String?              // For targeting a segment of users
  groupId           String?              // For targeting members of a group

  // Related content references
  entityType        String?              // E.g., "post", "event", etc.
  entityId          String?              // ID of the related entity

  // Additional data
  metadata          Json?

  // Tracking information
  sentCount         Int                  @default(0)
  openCount         Int                  @default(0)
  clickCount        Int                  @default(0)

  // Notification template
  templateId        String?
  template          NotificationTemplate? @relation(fields: [templateId], references: [id])

  @@index([recipientId])
  @@index([scheduledFor])
  @@index([status])
  @@index([groupId])
}

model NotificationTemplate {
  id                String   @id @default(cuid())
  name              String
  description       String?
  type              NotificationType
  titleTemplate     String?
  contentTemplate   String
  actionLabel       String?
  actionUrlTemplate String?
  imageUrl          String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Variables used in the template, stored as JSON
  variables         Json?

  // Notification settings
  channels          String   // Comma-separated: IN_APP,EMAIL,PUSH,SMS
  priority          NotificationPriority @default(NORMAL)

  // Related scheduled notifications
  scheduledNotifications ScheduledNotification[]
}

model NotificationLog {
  id                String   @id @default(cuid())
  notificationId    String
  userId            String
  channel           NotificationChannel
  event             String   // "delivered", "read", "clicked", "dismissed"
  deviceId          String?  // For push notifications
  deviceInfo        Json?    // Platform, browser, etc.
  timestamp         DateTime @default(now())
  success           Boolean  @default(true)
  errorMessage      String?

  // Extra data
  metadata          Json?

  @@index([notificationId])
  @@index([userId])
  @@index([channel])
  @@index([event])
  @@index([timestamp])
}

model AIChatInteraction {
  id          String   @id @default(cuid())
  userId      String
  userMessage String   @db.Text
  aiResponse  String   @db.Text
  modelUsed   String
  tokenUsage  Int
  createdAt   DateTime @default(now())

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

// Enums
enum Visibility {
  PUBLIC
  FRIENDS
  PRIVATE
}

// Notification related enums
enum NotificationPriority {
  LOW
  NORMAL
  HIGH
  URGENT
}

enum NotificationDeliveryStatus {
  PENDING
  DELIVERED
  FAILED
}

enum NotificationChannel {
  IN_APP
  EMAIL
  PUSH
  SMS
}

enum MediaType {
  IMAGE
  VIDEO
  AUDIO
  DOCUMENT
}

enum ReactionType {
  LIKE
  LOVE
  HAHA
  WOW
  SAD
  ANGRY
}

enum FriendshipStatus {
  PENDING
  ACCEPTED
  REJECTED
  BLOCKED
}

enum ChatRole {
  ADMIN
  MEMBER
}

enum NotificationType {
  // User-related notifications
  FOLLOW
  LIKE
  COMMENT
  MENTION
  FRIEND_REQUEST
  MESSAGE
  SYSTEM

  // Group-related notifications
  GROUP_INVITE
  GROUP_JOIN_REQUEST
  GROUP_JOIN_APPROVED
  GROUP_ROLE_CHANGE
  GROUP_POST
  GROUP_COMMENT
  GROUP_REACTION
  GROUP_EVENT
  GROUP_POLL
  GROUP_ANNOUNCEMENT
  GROUP_MENTION
  GROUP_FILE_UPLOAD
  GROUP_BADGE_AWARDED

  // Page-related notifications
  PAGE_INVITE
  PAGE_POST
  PAGE_EVENT

  // Content notifications
  POST_TRENDING
  CONTENT_REMOVED

  // AI-related notifications
  AI_RECOMMENDATION

  // Health-related notifications
  HEALTH_REMINDER
  HEALTH_GOAL_ACHIEVED

  // System notifications
  SECURITY_ALERT
  ACCOUNT_UPDATE
}

enum Role {
  OWNER
  ADMIN
  MODERATOR
  MEMBER
}

enum ParticipationStatus {
  GOING
  MAYBE
  INVITED
  DECLINED
}

//
// Group Models
//

// Group visibility types
enum GroupPrivacy {
  PUBLIC     // Anyone can see and join
  PRIVATE    // Anyone can see, but requires approval to join
  SECRET     // Only visible to members, requires invitation to join
}

// Group member role
enum GroupRole {
  OWNER       // Owner/Creator of the group
  ADMIN       // Admin with full permissions
  MODERATOR   // Can moderate content
  MEMBER      // Regular member
}

// Group content status
enum GroupContentStatus {
  PUBLISHED   // Approved and visible
  PENDING     // Pending moderation
  REJECTED    // Rejected by moderators
  ARCHIVED    // Archived/hidden
}

// Report status
enum ReportStatus {
  PENDING
  APPROVED
  REJECTED
  RESOLVED
}

// Report type
enum ReportType {
  SPAM
  HARASSMENT
  HATE_SPEECH
  MISINFORMATION
  INAPPROPRIATE_CONTENT
  OTHER
}

// Main Group model
model Group {
  id                  String       @id @default(cuid())
  name                String
  handle              String       @unique
  description         String?      @db.Text
  privacy             GroupPrivacy @default(PUBLIC)
  rules               String?      @db.Text
  logoImage           String?
  coverImage          String?
  isVerified          Boolean      @default(false)
  autoApproveMembers  Boolean      @default(true)
  allowMemberPosts    Boolean      @default(true)
  requirePostApproval Boolean      @default(false)
  createdAt           DateTime     @default(now())
  updatedAt           DateTime     @updatedAt

  // Group creator
  creatorId           String
  creator             User         @relation("GroupCreator", fields: [creatorId], references: [id], onDelete: Cascade)

  // Group relationships
  members             GroupMember[]
  invitations         GroupInvitation[]
  joinRequests        GroupJoinRequest[]
  posts               GroupPost[]
  topics              GroupTopic[]
  discussionTopics    GroupDiscussionTopic[]
  files               GroupFile[]
  events              GroupEvent[]
  polls               GroupPoll[]
  badges              GroupBadge[]
  reports             GroupReport[]
  notifications       Notification[]

  // Group settings
  settings            GroupSettings?

  @@index([creatorId])
}

// Group settings
model GroupSettings {
  id                        String    @id @default(cuid())
  welcomeMessage            String?   @db.Text
  primaryColor              String?
  enableMemberList          Boolean   @default(true)
  enableDiscussions         Boolean   @default(true)
  enableFiles               Boolean   @default(true)
  enableEvents              Boolean   @default(true)
  enablePolls               Boolean   @default(true)
  postNotificationsEnabled  Boolean   @default(true)
  commentNotificationsEnabled Boolean  @default(true)
  eventNotificationsEnabled Boolean   @default(true)
  allowNonMemberView        Boolean   @default(true)

  // Group relationship
  groupId                   String    @unique
  group                     Group     @relation(fields: [groupId], references: [id], onDelete: Cascade)
}

// Group topics/categories
model GroupTopic {
  id            String    @id @default(cuid())
  name          String
  description   String?
  color         String?
  icon          String?
  createdAt     DateTime  @default(now())

  groupId       String
  group         Group     @relation(fields: [groupId], references: [id], onDelete: Cascade)

  // Related content
  posts         GroupPost[]

  @@unique([groupId, name])
  @@index([groupId])
}

// Group membership
model GroupMember {
  id            String     @id @default(cuid())
  role          GroupRole  @default(MEMBER)
  joinedAt      DateTime   @default(now())
  lastActive    DateTime   @default(now())
  isActive      Boolean    @default(true)
  reputation    Int        @default(0)
  notes         String?

  userId        String
  user          User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  groupId       String
  group         Group      @relation(fields: [groupId], references: [id], onDelete: Cascade)

  // Member badges
  badges        GroupBadgeAssignment[]

  @@unique([groupId, userId])
  @@index([userId])
  @@index([groupId])
}

// Group invitation
model GroupInvitation {
  id            String    @id @default(cuid())
  createdAt     DateTime  @default(now())
  expiresAt     DateTime?
  message       String?
  status        String    @default("PENDING") // PENDING, ACCEPTED, REJECTED

  groupId       String
  group         Group     @relation(fields: [groupId], references: [id], onDelete: Cascade)

  invitedById   String
  invitedBy     User      @relation("InvitingUser", fields: [invitedById], references: [id], onDelete: Cascade)

  invitedUserId String
  invitedUser   User      @relation("InvitedUser", fields: [invitedUserId], references: [id], onDelete: Cascade)

  @@index([groupId])
  @@index([invitedUserId])
  @@index([invitedById])
}

// Group join requests
model GroupJoinRequest {
  id            String    @id @default(cuid())
  message       String?
  status        String    @default("PENDING") // PENDING, APPROVED, REJECTED
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  userId        String
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  groupId       String
  group         Group     @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([groupId])
}

// Group posts
model GroupPost {
  id            String              @id @default(cuid())
  content       String              @db.Text
  status        GroupContentStatus  @default(PUBLISHED)
  isPinned      Boolean             @default(false)
  isAnnouncement Boolean            @default(false)
  isEdited      Boolean             @default(false)
  viewCount     Int                 @default(0)
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt

  userId        String
  user          User                @relation(fields: [userId], references: [id], onDelete: Cascade)

  groupId       String
  group         Group               @relation(fields: [groupId], references: [id], onDelete: Cascade)

  topicId       String?
  topic         GroupTopic?         @relation(fields: [topicId], references: [id], onDelete: SetNull)

  // Related content
  media         Media[]
  comments      GroupComment[]
  reactions     GroupReaction[]

  @@index([userId])
  @@index([groupId])
  @@index([topicId])
}

// Group comments
model GroupComment {
  id            String              @id @default(cuid())
  content       String
  status        GroupContentStatus  @default(PUBLISHED)
  isEdited      Boolean             @default(false)
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt

  userId        String
  user          User                @relation(fields: [userId], references: [id], onDelete: Cascade)

  postId        String
  post          GroupPost           @relation(fields: [postId], references: [id], onDelete: Cascade)

  parentId      String?
  parent        GroupComment?       @relation("CommentReplies", fields: [parentId], references: [id], onDelete: SetNull)
  replies       GroupComment[]      @relation("CommentReplies")

  reactions     GroupReaction[]

  @@index([userId])
  @@index([postId])
  @@index([parentId])
}

// Group reactions
model GroupReaction {
  id            String       @id @default(cuid())
  type          ReactionType
  createdAt     DateTime     @default(now())

  userId        String
  user          User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  postId        String?
  post          GroupPost?   @relation(fields: [postId], references: [id], onDelete: Cascade)

  commentId     String?
  comment       GroupComment? @relation(fields: [commentId], references: [id], onDelete: Cascade)

  @@unique([userId, postId, commentId])
  @@index([userId])
  @@index([postId])
  @@index([commentId])
}

// Group discussions (forum)
model GroupDiscussionTopic {
  id            String      @id @default(cuid())
  title         String
  content       String      @db.Text
  isLocked      Boolean     @default(false)
  isPinned      Boolean     @default(false)
  viewCount     Int         @default(0)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  creatorId     String
  creator       User        @relation("TopicCreator", fields: [creatorId], references: [id], onDelete: Cascade)

  groupId       String
  group         Group       @relation(fields: [groupId], references: [id], onDelete: Cascade)

  replies       GroupDiscussionReply[]

  @@index([creatorId])
  @@index([groupId])
}

// Group discussion replies
model GroupDiscussionReply {
  id            String      @id @default(cuid())
  content       String      @db.Text
  isEdited      Boolean     @default(false)
  isAcceptedAnswer Boolean  @default(false)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  creatorId     String
  creator       User        @relation("ReplyCreator", fields: [creatorId], references: [id], onDelete: Cascade)

  topicId       String
  topic         GroupDiscussionTopic @relation(fields: [topicId], references: [id], onDelete: Cascade)

  parentId      String?
  parent        GroupDiscussionReply? @relation("ReplyReplies", fields: [parentId], references: [id], onDelete: SetNull)
  replies       GroupDiscussionReply[] @relation("ReplyReplies")

  @@index([creatorId])
  @@index([topicId])
  @@index([parentId])
}

// Group files
model GroupFile {
  id            String      @id @default(cuid())
  name          String
  description   String?
  fileType      String?
  fileSize      Int?
  fileUrl       String
  thumbnailUrl  String?
  downloadCount Int         @default(0)
  createdAt     DateTime    @default(now())

  uploaderId    String
  uploader      User        @relation("FileUploader", fields: [uploaderId], references: [id], onDelete: Cascade)

  groupId       String
  group         Group       @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@index([uploaderId])
  @@index([groupId])
}

// Group events
model GroupEvent {
  id            String    @id @default(cuid())
  title         String
  description   String?   @db.Text
  location      String?
  isOnline      Boolean   @default(false)
  onlineUrl     String?
  startsAt      DateTime
  endsAt        DateTime?
  coverImage    String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  creatorId     String
  creator       User      @relation("EventCreator", fields: [creatorId], references: [id], onDelete: Cascade)

  groupId       String
  group         Group     @relation(fields: [groupId], references: [id], onDelete: Cascade)

  participants  GroupEventParticipation[]

  @@index([creatorId])
  @@index([groupId])
}

// Group event participation
model GroupEventParticipation {
  id            String              @id @default(cuid())
  status        ParticipationStatus @default(GOING)
  createdAt     DateTime            @default(now())

  eventId       String
  event         GroupEvent          @relation(fields: [eventId], references: [id], onDelete: Cascade)

  userId        String
  user          User                @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([eventId, userId])
  @@index([eventId])
  @@index([userId])
}

// Group polls
model GroupPoll {
  id            String    @id @default(cuid())
  question      String
  description   String?
  isMultiChoice Boolean   @default(false)
  isAnonymous   Boolean   @default(false)
  expiresAt     DateTime?
  createdAt     DateTime  @default(now())

  creatorId     String
  creator       User      @relation("PollCreator", fields: [creatorId], references: [id], onDelete: Cascade)

  groupId       String
  group         Group     @relation(fields: [groupId], references: [id], onDelete: Cascade)

  options       GroupPollOption[]
  votes         GroupPollVote[]

  @@index([creatorId])
  @@index([groupId])
}

// Group poll options
model GroupPollOption {
  id            String    @id @default(cuid())
  text          String

  pollId        String
  poll          GroupPoll @relation(fields: [pollId], references: [id], onDelete: Cascade)

  votes         GroupPollVote[]

  @@index([pollId])
}

// Group poll votes
model GroupPollVote {
  id            String    @id @default(cuid())
  createdAt     DateTime  @default(now())

  userId        String
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  pollId        String
  poll          GroupPoll @relation(fields: [pollId], references: [id], onDelete: Cascade)

  optionId      String
  option        GroupPollOption @relation(fields: [optionId], references: [id], onDelete: Cascade)

  @@unique([userId, pollId, optionId])
  @@index([userId])
  @@index([pollId])
  @@index([optionId])
}

// Group badge system
model GroupBadge {
  id            String    @id @default(cuid())
  name          String
  description   String?
  image         String?
  criteria      String?
  points        Int       @default(0)
  createdAt     DateTime  @default(now())

  userId        String?
  user          User?     @relation(fields: [userId], references: [id], onDelete: SetNull)

  groupId       String
  group         Group     @relation(fields: [groupId], references: [id], onDelete: Cascade)

  assignments   GroupBadgeAssignment[]

  @@index([userId])
  @@index([groupId])
}

// Group badge assignments to members
model GroupBadgeAssignment {
  id            String    @id @default(cuid())
  awardedAt     DateTime  @default(now())
  reason        String?

  badgeId       String
  badge         GroupBadge @relation(fields: [badgeId], references: [id], onDelete: Cascade)

  memberId      String
  member        GroupMember @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@unique([badgeId, memberId])
  @@index([badgeId])
  @@index([memberId])
}

// Group report system
model GroupReport {
  id            String      @id @default(cuid())
  type          ReportType
  reason        String
  status        ReportStatus @default(PENDING)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  resolvedAt    DateTime?

  // Reporter
  creatorId     String
  creator       User        @relation("ReportCreator", fields: [creatorId], references: [id], onDelete: Cascade)

  // Group
  groupId       String
  group         Group       @relation(fields: [groupId], references: [id], onDelete: Cascade)

  // Reported content references (only one will be set)
  reportedUserId String?
  reportedUser   User?      @relation("ReportedUser", fields: [reportedUserId], references: [id], onDelete: SetNull)

  // Other reportable content IDs
  postId        String?
  commentId     String?

  @@index([creatorId])
  @@index([groupId])
  @@index([reportedUserId])
}